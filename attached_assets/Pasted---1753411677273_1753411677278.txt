# مواصفات نظام إدارة العقارات الشاملة

## نظرة عامة

نظام إدارة العقارات هو نظام شامل يعمل على أتمتة معالجة بيانات العقارات من خلال التكامل مع خدمات خارجية متعددة. يستقبل النظام إعلانات العقارات من تيليجرام، ويعالجها باستخدام سلسلة من مزودي الذكاء الاصطناعي، ويصنفها ذكياً، ويخزن البيانات في Notion و Zoho CRM، ويوفر واجهة ويب للمراقبة والإدارة.

## التحديثات الأخيرة (يوليو 2025)

### التعديلات المطلوبة:
1. **استبدال موديول Zoho CRM**: إرسال جميع البيانات إلى موديول "Aqar" بدلاً من "Lead"
2. **نظام الوسم والفلتر**: تطبيق وسم "عقار ناجح ✅" مع فلتر آخر تاريخ تحديث
3. **حقل البيان المركب**: دمج 9 حقول في حقل البيان (النوع، الحالة، المنطقة، المساحة، الدور، السعر، كود الشقة، الموظف، حالة الصور)
4. **سلسلة AI محدثة**: Gemini → OpenAI → Copilot → Mistral → Groq → التحليل المنطقي
5. **بوت إشعارات منفصل**: نظام إشعارات مستقل للنجاح/الفشل وطلبات الإذن
6. **تصنيفات محدثة**: عدم إنشاء مالك جديد للمكرر والمتعدد، مع Status متعدد القيم
7. **مطابقة Notion**: الاستعلام المباشر من Notion للمطابقة بدلاً من قاعدة البيانات المحلية

## معمارية النظام

### معمارية الخلفية (Backend)
- **إطار العمل**: FastAPI لواجهة الويب ونقاط API
- **اللغة**: Python 3.x مع أنماط async/await
- **قاعدة البيانات**: SQLite للتخزين المحلي والتخزين المؤقت
- **معالجة الذكاء الاصطناعي**: Anthropic Claude API لمعالجة اللغة الطبيعية
- **التكاملات الخارجية**: Telegram Bot API، Notion API، Zoho CRM API

### معمارية الواجهة الأمامية (Frontend)
- **إطار العمل**: Bootstrap 5 مع دعم RTL للعربية
- **JavaScript**: Vanilla JavaScript مع العمليات غير المتزامنة
- **التصميم**: CSS مخصص مع دعم اللغة العربية
- **القوالب**: محرك قوالب Jinja2

## تصنيف العقارات

### 1. عقار جديد (New Property)
عقار لم يتم العثور على سجلات مطابقة له في النظام.

**معايير التحقق:**
- لا يوجد تطابق في رقم المالك
- لا يوجد تطابق في مجموعة البيانات الأساسية

**سير العمل:**
1. إنشاء صفحة عقار جديدة في Notion
2. إنشاء أو ربط صفحة المالك
3. إنشاء سجل في Zoho CRM
4. إرسال إشعار نجاح مع روابط الصفحات

### 2. عقار مكرر (Duplicate Property)
يُصنّف على أنه مكرر إذا تحققت جميع الشروط التالية مقارنةً مع عقار آخر:

**شروط التطابق:**
- ✅ تطابق رقم المالك
- ✅ تطابق المنطقة
- ✅ تطابق نوع العقار
- ✅ تطابق حالة العقار
- ✅ تطابق المساحة
- ✅ تطابق الدور

**المعالجة:**
- وسم العقار كـ "مكرر"
- إرسال إشعار يتضمن:
  - رابط صفحة العقار المُعالج
  - رابط الصفحة المطابقة
- يمكن للمستخدم:
  - حذف العقار إذا كان التكرار غير صحيح
  - إلغاء وسم التكرار إذا كان صحيحاً

### 3. عقار متعدد (Multiple Property)
عقار يمتلك نفس رقم المالك فقط، لكن تختلف بقية البيانات.

**المعالجة:**
1. إنشاء صفحة عقار جديدة
2. ربطها بصفحة المالك الموجودة مسبقاً
3. إنشاء علاقة ثنائية بين الصفحة الجديدة وصفحة المالك
4. يصبح للمالك عقارات متعددة مرتبطة به

### 4. عقار فاشل (Failed Property)
عقار فشلت معالجته في أي مرحلة قبل الاكتمال.

**عند الاكتشاف:**
1. حذف الرسالة الأصلية
2. إنشاء رسالة جديدة تحتوي على "حقل البيان":
   - نوع العقار، حالة العقار، المنطقة
   - المساحة، الدور، السعر، كود الشقة
   - اسم الموظف، حالة الصور
   - اسم المالك، رقم المالك، إتاحة العقار
   - تفاصيل كاملة
3. وسم الرسالة بـ "عقار فاشل"
4. تبقى قابلة لإعادة المعالجة

### 5. عقار ناجح (Successful Property)
عقار اكتملت جميع حقوله ومعلوماته بنجاح.

**بعد النجاح:**
1. التصدير إلى Zoho و Notion
2. حذف الرسالة الأصلية في القناة
3. إرسال رسالة منسقة جديدة بنفس تنسيق "عقار فاشل"
4. وسمها "عقار ناجح"

## سير معالجة العقارات

### استهداف الرسائل
- تستهدف جميع العقارات الموجودة ما لم تكن موسومة بـ "عقار ناجح"
- يمكن تفعيل فلتر تاريخ آخر تحديث ناجح
- تخطي الرسائل الأقدم بعد تنظيف القناة

### دورة المعالجة
1. **استلام البيان**: من تيليجرام (نص فقط، تجاهل غير النصية)
2. **تحليل الذكاء الاصطناعي**: سلسلة AI المحدثة بالتتابع:
   - Gemini → OpenAI → Copilot → Mistral → Groq
   - 3 محاولات لكل مزود
   - فاصل زمني 15 ثانية
3. **في حال فشل الجميع**: سؤال المستخدم "هل نكمل بالتحليل المنطقي؟"
4. **بعد الحصول على JSON**:
   - توجيهه لقناة أرشيفية
   - إرسال البيانات إلى Notion و Zoho
   - إشعار نجاح/فشل
5. **بعد كل دفعة**: إعادة تشغيل المعالجة للعقارات الفاشلة

## المكونات الأساسية

### الخدمات الرئيسية
- **AIService**: معالجة استخراج بيانات العقارات من النص العربي
- **NotionService**: إدارة بيانات العقارات والملاك في قواعد بيانات Notion
- **TelegramService**: معالجة استلام الرسائل وإرسال الإشعارات
- **ZohoService**: مزامنة بيانات العقارات مع نظام Zoho CRM
- **DatabaseManager**: قاعدة بيانات SQLite المحلية للتخزين المؤقت وحالة النظام

### نماذج البيانات
- **PropertyData**: هيكل معلومات العقار الشامل
- **PropertyStatus**: تعداد حالات معالجة العقار
- **Property Enums**: قيم محددة للإتاحة والحالة والنوع

## التدفق البياني

1. **استيعاب الرسائل**: مراقبة قناة تيليجرام للإعلانات الجديدة
2. **معالجة الذكاء الاصطناعي**: إرسال النص العربي الخام إلى Claude API
3. **كشف التكرار**: البحث في Notion عن العقارات الموجودة
4. **تخزين البيانات**:
   - تفاصيل العقار في قاعدة بيانات Notion Properties
   - معلومات المالك في قاعدة بيانات Notion Owners
   - سجل كامل في Zoho CRM
5. **الإشعار**: إرسال نتيجة التصنيف إلى بوت تيليجرام مع الروابط

## التقارير اليومية

**محتوى التقرير اليومي:**
- عدد ونسب كل تصنيف
- روابط الصفحات
- توزيع حسب الموظف
- إحصائيات الأداء

## سلسلة مزودي الذكاء الاصطناعي المحدثة

### ترتيب المعالجة:
1. **Gemini** (3 محاولات، 15 ثانية فاصل)
2. **OpenAI** (3 محاولات، 15 ثانية فاصل) 
3. **Copilot** (3 محاولات، 15 ثانية فاصل)
4. **Mistral** (3 محاولات، 15 ثانية فاصل)
5. **Groq** (3 محاولات، 15 ثانية فاصل)
6. **طلب إذن للتحليل المنطقي**
7. **التحليل المنطقي بـ Python** أو **التحليل اليدوي**

### مفاتيح API المحدثة:
- **Mistral**: `soMr4s2jGPzGrKO00BOjOh7Vrhb5IxMP`
- **Groq**: `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`

## متغيرات البيئة المحدثة

```env
# Telegram - البوتين
TELEGRAM_BOT_TOKEN=your_main_bot_token
TELEGRAM_NOTIFICATION_BOT_TOKEN=your_notification_bot_token
TELEGRAM_CHANNEL_ID=your_channel_id
TELEGRAM_ARCHIVE_CHANNEL_ID=your_archive_channel_id

# Notion
NOTION_INTEGRATION_SECRET=your_notion_secret
NOTION_PROPERTIES_DB_ID=your_properties_db_id
NOTION_OWNERS_DB_ID=your_owners_db_id

# AI Services - جميع المزودين
ANTHROPIC_API_KEY=your_anthropic_key
OPENAI_API_KEY=your_openai_key
GEMINI_API_KEY=your_gemini_key
MISTRAL_API_KEY=soMr4s2jGPzGrKO00BOjOh7Vrhb5IxMP
GROQ_API_KEY=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

# Zoho CRM - موديول Aqar الجديد
ZOHO_CLIENT_ID=your_zoho_client_id
ZOHO_CLIENT_SECRET=your_zoho_client_secret
ZOHO_REFRESH_TOKEN=your_zoho_refresh_token
ZOHO_MODULE_NAME=Aqar
