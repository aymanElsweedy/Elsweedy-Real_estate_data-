
#!/usr/bin/env python3
"""
ุงุฎุชุจุงุฑ ุดุงูู ูููุธุงู: ุฅุฑุณุงู ุฑุณุงุฆู ุฌุฏูุฏุฉ ููุนุงูุฌุฉ ุฌููุน ุงูุฑุณุงุฆู ุงูููุฌูุฏุฉ ูู ุงูููุงุฉ
"""

import asyncio
import os
from datetime import datetime
from config import Config
from services.telegram_service import TelegramService
from services.ai_service import AIService
from utils.logger import setup_logger

logger = setup_logger(__name__)

# ุฑุณุงุฆู ุนูุงุฑูุฉ ุฌุฏูุฏุฉ ููุฅุฑุณุงู ูุงูุงุฎุชุจุงุฑ
NEW_PROPERTY_MESSAGES = [
    """
๐ ุดูุฉ ููุฅูุฌุงุฑ - ุงูุชุฌูุน ุงูุฎุงูุณ

ุงูููุทูุฉ: ุงุญูุงุก ุชุฌูุน
ุงูููุน: ุดูุฉ ุณูููุฉ
ุงููุณุงุญุฉ: 150 ูุชุฑ ูุฑุจุน
ุงูุฏูุฑ: ุงูุซุงูู
ุงูุณุนุฑ: 28000 ุฌููู ุดูุฑูุงู
ุงูุญุงูุฉ: ููุฑูุด

ุงููููุฒุงุช:
- ุชุดุทูุจ ุณูุจุฑ ูููุณ
- ุญุฏููู
- ุงุณุงูุณูุฑ
- ููู ููุชูุญ

ููุชูุงุตู: ุจูุจู - 01234567890
ุงููุงูู: ุงุญูุฏ ูุญููุฏ - 01012345678
ูุชููุฑ ุตูุฑ ูููุญุฏุฉ

ุงูุนููุงู: ุงูุชุฌูุน ุงูุฎุงูุณุ ุงููุงูุฑุฉ ุงูุฌุฏูุฏุฉ
ูุชุงุญ ูููุนุงููุฉ
    """,
    """
๐ก ุดูุฉ ููุฑูุดุฉ - ุงูุฏูุณ

ุงูููุทูุฉ: ุงูุฏูุณ
ุงูููุน: ุดูุฉ
ุงููุณุงุญุฉ: 130 ูุชุฑ
ุงูุฏูุฑ: ุฏูุฑ ุชุงูุช
ุงูุณุนุฑ: 20000 ุฌููู ุดูุฑูุงู
ุงูุญุงูุฉ: ููุฑูุด

ุงููููุฒุงุช:
- ููููู
- ููู ููุชูุญ
- ุงุณุงูุณูุฑ
- ุงูุชุฑูุช
- ุงุฌูุฒู ููุฑุจุงุฆูู

ููุชูุงุตู: ููุณู ุนูุงุฏ - 01987654321
ุงููุงูู: ูุฏู ุงูููุชู - 01000011109
ุจุฏูู ุตูุฑ ุญุงููุงู

ุงูุนููุงู: ุงูุฏูุณุ ุงููุงูุฑุฉ ุงูุฌุฏูุฏุฉ
ุบูุฑ ูุชุงุญู ุญุงููุงู
    """,
    """
๐ข ุดูุฉ ุชูููู - ุฌุงุฑุฏูููุง

ุงูููุทูุฉ: ุฌุงุฑุฏูููุง
ุงูููุน: ุดูุฉ
ุงููุณุงุญุฉ: 200 ูุชุฑ
ุงูุฏูุฑ: ุฏูุฑ ุฎุงูุณ
ุงูุณุนุฑ: 2500000 ุฌููู
ุงูุญุงูุฉ: ุชูููู

ุงููููุฒุงุช:
- ุชุดุทูุจ ุณูุจุฑ ูููุณ
- ุงุณุงูุณูุฑ
- ููู ุฌุงุฑุฏู
- ูุณุฌูู ุดูุฑ ุนูุงุฑู

ููุชูุงุตู: ูุญููุฏ ุณุงูู - 01555666777
ุงููุงูู: ุฃููุฑุฉ ุฎุงูุฏ - 01333444555
ูุชููุฑ ุตูุฑ

ุงูุนููุงู: ููุจููุฏ ุฌุงุฑุฏูููุงุ ุงูุญู ุงูุฎุงูุณ
ูุชุงุญ ูููุนุงููุฉ
    """
]

async def send_new_messages_to_channel():
    """ุฅุฑุณุงู ุฑุณุงุฆู ุนูุงุฑูุฉ ุฌุฏูุฏุฉ ุฅูู ุงูููุงุฉ"""
    
    config = Config()
    
    print("๐ค ุฅุฑุณุงู ุฑุณุงุฆู ุนูุงุฑูุฉ ุฌุฏูุฏุฉ ุฅูู ุงูููุงุฉ...")
    
    try:
        async with TelegramService(config) as telegram_service:
            sent_count = 0
            
            for i, message in enumerate(NEW_PROPERTY_MESSAGES, 1):
                print(f"๐ค ุฅุฑุณุงู ุงูุฑุณุงูุฉ {i}/{len(NEW_PROPERTY_MESSAGES)}")
                
                success = await telegram_service.send_message_to_channel(message)
                
                if success:
                    print(f"โ ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ {i} ุจูุฌุงุญ")
                    sent_count += 1
                else:
                    print(f"โ ูุดู ุฅุฑุณุงู ุงูุฑุณุงูุฉ {i}")
                
                # ุชููู ูุตูุฑ ุจูู ุงูุฑุณุงุฆู
                await asyncio.sleep(3)
            
            print(f"โ ุชู ุฅุฑุณุงู {sent_count}/{len(NEW_PROPERTY_MESSAGES)} ุฑุณุงูุฉ ุฌุฏูุฏุฉ")
            
            # ุงูุชุธุงุฑ ููุนุงูุฌุฉ ุงูุฑุณุงุฆู
            print("โณ ุงูุชุธุงุฑ 10 ุซูุงูู ูุจู ุจุฏุก ุงููุนุงูุฌุฉ...")
            await asyncio.sleep(10)
            
            return sent_count > 0
            
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฑุณุงุฆู: {e}")
        return False

async def process_all_channel_messages():
    """ูุนุงูุฌุฉ ุฌููุน ุฑุณุงุฆู ุงูููุงุฉ"""
    
    config = Config()
    
    print("๐ ุจุฏุก ูุนุงูุฌุฉ ุฌููุน ุฑุณุงุฆู ุงูููุงุฉ...")
    
    try:
        async with TelegramService(config) as telegram_service:
            ai_service = AIService(config)
            
            # ุงูุญุตูู ุนูู ุฌููุน ุงูุฑุณุงุฆู
            print("๐ฅ ุฌูุจ ุฑุณุงุฆู ุงูููุงุฉ...")
            messages = await telegram_service.get_channel_messages(limit=100, apply_filter=True)
            
            if not messages:
                print("โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑุณุงุฆู ูููุนุงูุฌุฉ")
                return False
            
            print(f"๐ ุชู ุงูุนุซูุฑ ุนูู {len(messages)} ุฑุณุงูุฉ ูููุนุงูุฌุฉ")
            
            # ูุนุงูุฌุฉ ูู ุฑุณุงูุฉ
            processed_count = 0
            successful_count = 0
            failed_count = 0
            
            for i, message in enumerate(messages, 1):
                print(f"\n๐ ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ {i}/{len(messages)}")
                print(f"๐ ูุนุฑู ุงูุฑุณุงูุฉ: {message.get('message_id')}")
                
                raw_text = message.get('text', '').strip()
                if not raw_text:
                    print("โ๏ธ ุฑุณุงูุฉ ูุงุฑุบุฉุ ุชุฎุทู...")
                    continue
                
                print(f"๐ ุทูู ุงููุต: {len(raw_text)} ุญุฑู")
                
                try:
                    # ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช
                    print("๐ค ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู...")
                    property_data = await ai_service.extract_property_data(raw_text)
                    
                    if property_data:
                        print("โ ุชู ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุจูุฌุงุญ!")
                        
                        # ุนุฑุถ ุงูุจูุงูุงุช ุงููููุฉ
                        print(f"   ๐๏ธ ุงูููุทูุฉ: {property_data.get('ุงูููุทูุฉ', 'ุบูุฑ ูุญุฏุฏ')}")
                        print(f"   ๐ ููุน ุงููุญุฏุฉ: {property_data.get('ููุน ุงููุญุฏุฉ', 'ุบูุฑ ูุญุฏุฏ')}")
                        print(f"   ๐ ุงููุณุงุญุฉ: {property_data.get('ุงููุณุงุญุฉ', 'ุบูุฑ ูุญุฏุฏ')} ูุชุฑ")
                        print(f"   ๐ฐ ุงูุณุนุฑ: {property_data.get('ุงูุณุนุฑ', 'ุบูุฑ ูุญุฏุฏ')} ุฌููู")
                        print(f"   ๐ค ุงููุงูู: {property_data.get('ุงุณู ุงููุงูู', 'ุบูุฑ ูุญุฏุฏ')}")
                        
                        # ุนุฑุถ ุงูุจูุงู ุงููุฏูุฌ
                        statement = property_data.get('ุงูุจูุงู', '')
                        if statement:
                            print(f"๐ ุงูุจูุงู ุงููุฏูุฌ:")
                            statement_lines = statement.split('\n')[:3]  # ุฃูู 3 ุฃุณุทุฑ ููุท
                            for line in statement_lines:
                                if line.strip():
                                    print(f"   {line}")
                            if len(statement.split('\n')) > 3:
                                print("   ...")
                        
                        # ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
                        is_valid, validation_errors = await ai_service.validate_property_data(property_data)
                        
                        if is_valid:
                            print("โ ุงูุจูุงูุงุช ุตุญูุญุฉ ูููุชููุฉ")
                            successful_count += 1
                            
                            # ูุญุงูุงุฉ ุฅุถุงูุฉ ูุณู ุงููุฌุงุญ
                            print("๐ท๏ธ ุณูุชู ุฅุถุงูุฉ ูุณู ุงููุฌุงุญ")
                            
                        else:
                            print(f"โ๏ธ ูุดุงูู ูู ุงูุจูุงูุงุช ({len(validation_errors)} ูุดููุฉ)")
                            for error in validation_errors[:2]:  # ุฃูู ูุดููุชูู ููุท
                                print(f"   - {error}")
                            if len(validation_errors) > 2:
                                print("   ...")
                            failed_count += 1
                            print("โ ุณูุชู ุฅุถุงูุฉ ูุณู ุงููุดู")
                    
                    else:
                        print("โ ูุดู ูู ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช")
                        failed_count += 1
                        
                except Exception as e:
                    print(f"โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ: {e}")
                    failed_count += 1
                
                processed_count += 1
                
                # ุชููู ูุตูุฑ ุจูู ุงูุฑุณุงุฆู
                await asyncio.sleep(1)
            
            # ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ
            print("\n" + "=" * 60)
            print("๐ ูุชุงุฆุฌ ุงููุนุงูุฌุฉ:")
            print(f"   ๐ ุฅุฌูุงูู ุงูุฑุณุงุฆู: {processed_count}")
            print(f"   โ ุฑุณุงุฆู ูุงุฌุญุฉ: {successful_count}")
            print(f"   โ ุฑุณุงุฆู ูุงุดูุฉ: {failed_count}")
            
            if processed_count > 0:
                success_rate = (successful_count / processed_count) * 100
                print(f"   ๐ ูุนุฏู ุงููุฌุงุญ: {success_rate:.1f}%")
            
            print("=" * 60)
            
            return True
            
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุฑุณุงุฆู: {e}")
        return False

async def main():
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ููุงุฎุชุจุงุฑ ุงูุดุงูู"""
    
    print("๐ ุงุฎุชุจุงุฑ ุดุงูู ููุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช")
    print("=" * 60)
    
    # ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช
    config = Config()
    if not config.validate():
        print("โ ูุดู ูู ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช")
        print("๐ก ุชุฃูุฏ ูู ุฅุถุงูุฉ ุฌููุน ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงููุทููุจุฉ")
        return
    
    print("โ ุชู ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ")
    print(f"๐ฑ ููุงุฉ ุงูุชููุฌุฑุงู: {config.TELEGRAM_CHANNEL_ID}")
    print(f"๐ค ูุฒูุฏู AI ูุชุงุญูู: {', '.join(config.get_available_ai_providers())}")
    print("=" * 60)
    
    try:
        # ุงูุฎุทูุฉ 1: ุฅุฑุณุงู ุฑุณุงุฆู ุฌุฏูุฏุฉ
        print("\n๐ ุงูุฎุทูุฉ 1: ุฅุฑุณุงู ุฑุณุงุฆู ุนูุงุฑูุฉ ุฌุฏูุฏุฉ")
        send_success = await send_new_messages_to_channel()
        
        if send_success:
            print("โ ุชู ุฅุฑุณุงู ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ ุจูุฌุงุญ")
        else:
            print("โ๏ธ ูุดู ูู ุฅุฑุณุงู ุงูุฑุณุงุฆู ุงูุฌุฏูุฏุฉ (ุณูุชู ุงููุชุงุจุนุฉ)")
        
        # ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุฌููุน ุงูุฑุณุงุฆู
        print("\n๐ ุงูุฎุทูุฉ 2: ูุนุงูุฌุฉ ุฌููุน ุฑุณุงุฆู ุงูููุงุฉ")
        process_success = await process_all_channel_messages()
        
        if process_success:
            print("\n๐ ุชู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู ุจูุฌุงุญ!")
            print("๐ก ููููู ุงูุขู ุชุดุบูู ุงููุธุงู ุงููุงูู:")
            print("   python main.py")
        else:
            print("\nโ๏ธ ุญุฏุซุช ูุดุงูู ูู ุงููุนุงูุฌุฉ")
            print("๐ก ุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช ูุงูุงุชุตุงู ุจุงูุฎุฏูุงุช")
            
    except Exception as e:
        print(f"\nโ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ ุงูุดุงูู: {e}")

if __name__ == "__main__":
    asyncio.run(main())
